# distill.domain = iso-price

domain object and operation decomposition for the iso-price package.

---

## 1. usecases and envisioned contracts

### usecase.1: track llm inference cost

```ts
import { dividePrice, multiplyPrice } from 'iso-price';

// define rate per token
const inputRate = dividePrice({ of: '$0.25', by: 1_000_000 });
// => 'USD $0.000_000_250' (nano.x10^-9 precision)

// calculate cost for usage (e.g., 47_382 tokens)
const inputCost = multiplyPrice({ of: inputRate, by: 47_382 });
// => 'USD 0.011_845_500' (nano.x10^-9 precision)
```

### usecase.2: accumulate costs over period

```ts
import { sumPrices, asIsoPrice } from 'iso-price';

// sum prices from database (IsoPriceWords persisted as TEXT)
const subtotal = sumPrices(costs.map(row => row.cost));
// => 'USD 47.856_675_470' (nano.x10^-9 precision)
```

### usecase.3: apply markup and round for invoice

```ts
import { multiplyPrice, roundPrice } from 'iso-price';

// apply 1% markup
const withMarkup = multiplyPrice({ of: subtotal, by: 1.01 });
// => 'USD 47.856_675_470' (nano.x10^-9 precision)

// round to cents for invoice
const invoiceTotal = roundPrice({ of: withMarkup, to: 'centi.x10^-2' }, { format: 'shape', round: 'ceil' });
// => { amount: 4786n, currency: 'USD' }
```

### usecase.4: integrate with stripe

```ts
await stripe.invoiceItems.create({
  customer: stripeCustomerId,
  amount: Number(invoiceTotal.amount),           // 4786 cents
  currency: invoiceTotal.currency.toLowerCase(), // 'usd'
});
```

### usecase.5: split bill among parties

```ts
import { allocatePrice } from 'iso-price';

const parts = allocatePrice({ of: 'USD 10.00', into: { parts: 3 }, remainder: 'first' });
// => ['USD 3.34', 'USD 3.33', 'USD 3.33']
// sum: $10.00 ✓
```

### usecase.6: prorate by ratio

```ts
const parts = allocatePrice({ of: 'USD 5.00', into: { ratios: [7, 3] }, remainder: 'first' });
// => ['USD 3.50', 'USD 1.50']
```

---

## 2. domain objects

### 2.1 literals

#### IsoPriceShape

the structured representation of a price with explicit precision.

```ts
interface IsoPriceShape<
  TCurrency extends string = string,
  TExponent extends IsoPriceExponent = IsoPriceExponent,
> {
  amount: bigint;
  currency: TCurrency;
  exponent?: TExponent;
}

class IsoPriceShape<TCurrency, TExponent>
  extends DomainLiteral<IsoPriceShape<TCurrency, TExponent>>
  implements IsoPriceShape<TCurrency, TExponent> {}
```

- `amount` = bigint (always bigint, never number — see research.claims)
- `currency` = ISO 4217 code or custom (e.g., 'BTC')
- `exponent` = optional, defaults to currency standard (e.g., 'centi.x10^-2' for USD)

extends `DomainLiteral` — identity is determined by all non-metadata properties.

#### IsoPriceWords

the string representation of a price in code-prefix format with numeric separator notation.

```ts
type IsoPriceWords<TCurrency extends string = string> = AsOfGlossary<
  `${TCurrency} ${string}`,
  'IsoPriceWords'
>;
```

examples:
- `'USD 50.37'` — standard cents
- `'USD 1_000_000.50'` — numeric separator notation (ES2021)
- `'USD 0.000_047_382'` — micro-dollar precision
- `'JPY 1_000'` — zero-decimal currency

this is a branded template literal — the `__brand` ensures type safety at compile time.

#### IsoPriceHuman

the symbol-format representation for display and convenient input.

```ts
type IsoPriceHuman = AsOfGlossary<string, 'IsoPriceHuman'>;
```

examples:
- `'$50.37'` — USD
- `'€100.00'` — EUR
- `'¥1,000'` — JPY

note: symbols are lossy compression — `$` could mean USD, CAD, AUD, etc. (see briefs/define.currency-symbols-lossy.md)

### 2.2 union types

#### IsoPrice

the union of all price representations. all operations accept any variant.

```ts
type IsoPrice<TCurrency extends string = string> =
  | IsoPriceWords<TCurrency>
  | IsoPriceShape<TCurrency>
  | IsoPriceHuman;
```

#### IsoPriceExponent

the precision level for price amounts.

```ts
type IsoPriceExponent =
  | 'whole.x10^0'    // whole units (JPY, KRW)
  | 'centi.x10^-2'   // cents (USD, EUR, GBP)
  | 'milli.x10^-3'   // fils (BHD, KWD, OMR)
  | 'micro.x10^-6'   // micro-dollars (llm token costs)
  | 'nano.x10^-9'    // nano-dollars (serverless costs)
  | 'pico.x10^-12';  // pico-dollars (extreme precision)
```

#### IsoPriceRoundMode

the round strategy for precision decrease.

```ts
type IsoPriceRoundMode =
  | 'floor'      // round toward negative infinity
  | 'ceil'       // round toward positive infinity
  | 'half-up'    // round half away from zero (financial standard)
  | 'half-down'  // round half toward zero
  | 'half-even'; // banker's round
```

### 2.3 enums

#### IsoCurrency

the top currencies by trade volume plus 3-decimal currencies.

```ts
enum IsoCurrency {
  USD = 'USD', EUR = 'EUR', JPY = 'JPY', GBP = 'GBP', CNY = 'CNY',
  AUD = 'AUD', CAD = 'CAD', CHF = 'CHF', HKD = 'HKD', NZD = 'NZD',
  SEK = 'SEK', KRW = 'KRW', SGD = 'SGD', NOK = 'NOK', MXN = 'MXN',
  INR = 'INR', ZAR = 'ZAR', BRL = 'BRL', DKK = 'DKK', PLN = 'PLN',
  THB = 'THB', BHD = 'BHD', KWD = 'KWD', OMR = 'OMR', TND = 'TND',
}
```

note: custom currencies (BTC, ETH) remain supported via `string` type parameter.

### 2.4 entities

none — iso-price is a pure domain library for price computation. no persistence layer.

### 2.5 events

none — iso-price operations are synchronous transformations with no side effects.

---

## 3. domain operations

### 3.1 cast functions

| operation         | input                | output          | description                         |
| ----------------- | -------------------- | --------------- | ----------------------------------- |
| `asIsoPrice`      | `IsoPrice \| string` | `IsoPriceWords` | normalize any price to words format |
| `asIsoPriceWords` | `IsoPrice`           | `IsoPriceWords` | convert to words format             |
| `asIsoPriceShape` | `IsoPrice`           | `IsoPriceShape` | convert to shape format             |
| `asIsoPriceHuman` | `IsoPrice`           | `IsoPriceHuman` | convert to symbol format            |

#### asIsoPrice

```ts
const asIsoPrice: (
  input: IsoPrice | string,
  options?: { currency?: string },
) => IsoPriceWords;

// examples
asIsoPrice('$50.37')                      // => 'USD 50.37'
asIsoPrice('$50.37', { currency: 'CAD' }) // => 'CAD 50.37'
asIsoPrice('USD 50.37')                   // => 'USD 50.37' (passthrough)
asIsoPrice({ amount: 5037n, currency: 'USD' }) // => 'USD 50.37'
```

#### asIsoPriceShape

```ts
const asIsoPriceShape: <TCurrency extends string = string>(
  input: IsoPrice | { amount: number | bigint; currency: TCurrency; exponent?: IsoPriceExponent },
) => IsoPriceShape<TCurrency>;

// examples
asIsoPriceShape('USD 50.37')              // => { amount: 5037n, currency: 'USD' }
asIsoPriceShape({ amount: 5037, currency: 'USD' }) // => { amount: 5037n, currency: 'USD' }
```

### 3.2 type guards

| operation         | input     | output    | description                    |
| ----------------- | --------- | --------- | ------------------------------ |
| `isIsoPrice`      | `unknown` | `boolean` | true if words, shape, or human |
| `isIsoPriceWords` | `unknown` | `boolean` | true if valid words format     |
| `isIsoPriceShape` | `unknown` | `boolean` | true if valid shape format     |
| `isIsoPriceHuman` | `unknown` | `boolean` | true if valid human format     |

#### isIsoPriceWords with .assure()

```ts
interface IsIsoPriceWords {
  (input: unknown): input is IsoPriceWords;
  assure: (input: unknown) => IsoPriceWords;
}

// examples
isIsoPriceWords('USD 50.37')        // => true
isIsoPriceWords('invalid')          // => false
isIsoPriceWords.assure('USD 50.37') // => 'USD 50.37' (branded)
isIsoPriceWords.assure('invalid')   // throws BadRequestError
```

### 3.3 arithmetic operations

| operation                 | input                                                        | output            | description              |
| ------------------------- | ------------------------------------------------------------ | ----------------- | ------------------------ |
| `sumPrices` / `addPrices` | `...IsoPrice[]` or `[IsoPrice[], options?]`                  | `IsoPriceWords`   | sum prices               |
| `subPrices`               | `...IsoPrice[]` or `[IsoPrice[], options?]`                  | `IsoPriceWords`   | subtract prices          |
| `multiplyPrice`           | `{ of: IsoPrice, by: number }`                               | `IsoPriceWords`   | multiply price by scalar |
| `dividePrice`             | `{ of: IsoPrice, by: number }`                               | `IsoPriceWords`   | divide price by scalar   |
| `allocatePrice`           | `{ of: IsoPrice, into: { parts } \| { ratios }, remainder }` | `IsoPriceWords[]` | split price losslessly   |

#### sumPrices / addPrices

```ts
const sumPrices: {
  (...prices: IsoPrice[]): IsoPriceWords;
  (prices: IsoPrice[], options?: { format?: 'words' | 'shape' }): IsoPriceWords | IsoPriceShape;
};

// alias
export { sumPrices as addPrices };

// examples
sumPrices('USD 10.00', 'USD 20.00')             // => 'USD 30.00'
addPrices('USD 10.00', 'USD 20.00')             // => 'USD 30.00' (alias)
sumPrices(['USD 10.00', 'USD 20.00'])           // => 'USD 30.00'
sumPrices(['USD 10.00', 'USD 20.00'], { format: 'shape' }) // => { amount: 3000n, currency: 'USD' }
```

#### multiplyPrice

```ts
const multiplyPrice: (
  input: { of: IsoPrice; by: number },
  options?: { round?: IsoPriceRoundMode; format?: 'words' | 'shape' },
) => IsoPriceWords | IsoPriceShape;

// examples
multiplyPrice({ of: 'USD 10.00', by: 3 })       // => 'USD 30.00'
multiplyPrice({ of: 'USD 10.00', by: 1.5 })     // => 'USD 15.00'
```

#### dividePrice

```ts
const dividePrice: (
  input: { of: IsoPrice; by: number },
  options?: { round?: IsoPriceRoundMode; format?: 'words' | 'shape' },
) => IsoPriceWords | IsoPriceShape;

// examples
dividePrice({ of: '$0.25', by: 1_000_000 })     // => 'USD 0.000_000_250'
```

#### allocatePrice

```ts
const allocatePrice: (
  input: {
    of: IsoPrice;
    into: { parts: number } | { ratios: number[] };
    remainder: 'first' | 'last' | 'largest' | 'random';
  },
  options?: { format?: 'words' | 'shape' },
) => IsoPriceWords[] | IsoPriceShape[];

// examples
allocatePrice({ of: 'USD 10.00', into: { parts: 3 }, remainder: 'first' })
// => ['USD 3.34', 'USD 3.33', 'USD 3.33']

allocatePrice({ of: 'USD 5.00', into: { ratios: [7, 3] }, remainder: 'first' })
// => ['USD 3.50', 'USD 1.50']
```

### 3.4 precision operations

| operation                       | input                                           | output             | description              |
| ------------------------------- | ----------------------------------------------- | ------------------ | ------------------------ |
| `setPricePrecision`             | `{ of: IsoPrice, to: IsoPriceExponent }`        | `IsoPriceWords`    | change precision         |
| `roundPrice`                    | `{ of: IsoPrice, to: IsoPriceExponent }`        | `IsoPriceWords`    | round to precision       |
| `getIsoPriceExponentByCurrency` | `string`                                        | `IsoPriceExponent` | lookup standard exponent |

#### setPricePrecision

```ts
const setPricePrecision: (
  input: { of: IsoPrice; to: IsoPriceExponent },
  options?: { round?: IsoPriceRoundMode; format?: 'words' | 'shape' },
) => IsoPriceWords | IsoPriceShape;

// examples
setPricePrecision({ of: 'USD 50.37', to: 'micro.x10^-6' })
// => 'USD 50.370_000' (lossless increase)

setPricePrecision({ of: 'USD 5.555', to: 'centi.x10^-2' }, { round: 'half-up' })
// => 'USD 5.56' (lossy decrease)
```

#### roundPrice

```ts
const roundPrice: (
  input: { of: IsoPrice; to: IsoPriceExponent },
  options?: { round?: IsoPriceRoundMode; format?: 'words' | 'shape' },
) => IsoPriceWords | IsoPriceShape;

// examples
roundPrice({ of: 'USD 47.856_675', to: 'centi.x10^-2' })
// => 'USD 47.86' (default half-up)

roundPrice({ of: withMarkup, to: 'centi.x10^-2' }, { format: 'shape' })
// => { amount: 4786n, currency: 'USD' }

roundPrice({ of: 'USD 5.555', to: 'centi.x10^-2' }, { round: 'floor' })
// => 'USD 5.55'
```

#### getIsoPriceExponentByCurrency

```ts
const getIsoPriceExponentByCurrency: (currency: string) => IsoPriceExponent;

// examples
getIsoPriceExponentByCurrency('USD') // => 'centi.x10^-2'
getIsoPriceExponentByCurrency('JPY') // => 'whole.x10^0'
getIsoPriceExponentByCurrency('BHD') // => 'milli.x10^-3'
getIsoPriceExponentByCurrency('BTC') // => 'centi.x10^-2' (default for unknown)
```

### 3.5 statistics

| operation        | input                                       | output                  | description        |
| ---------------- | ------------------------------------------- | ----------------------- | ------------------ |
| `calcPriceStdev` | `...IsoPrice[]` or `[IsoPrice[], options?]` | `IsoPriceWords \| null` | standard deviation |

#### calcPriceStdev

```ts
const calcPriceStdev: {
  (...prices: IsoPrice[]): IsoPriceWords | null;
  (prices: IsoPrice[], options?: { format?: 'words' | 'shape' }): IsoPriceWords | IsoPriceShape | null;
};

// examples
calcPriceStdev('USD 10.00', 'USD 20.00', 'USD 30.00')
// => 'USD 10.00'
```

---

## 4. relationships

### 4.1 type hierarchy

```
IsoPrice (union)
├── IsoPriceWords (branded string, code-prefix format)
├── IsoPriceShape (structured literal)
└── IsoPriceHuman (branded string, symbol format)
```

### 4.2 format conversion graph

```
IsoPriceHuman ──asIsoPrice──► IsoPriceWords
                                    │
                                    ▼
IsoPriceShape ◄──asIsoPriceShape── IsoPrice
                                    │
                                    ▼
                            asIsoPriceHuman
                                    │
                                    ▼
                            IsoPriceHuman
```

### 4.3 operation flow

```
input (IsoPrice)
    │
    ▼
asIsoPriceShape (internal)
    │
    ▼
computation (bigint arithmetic)
    │
    ▼
asIsoPriceWords (default output)
    or
asIsoPriceShape (when { format: 'shape' })
```

### 4.4 precision hierarchy

```
pico.x10^-12  (extreme precision)
    │
nano.x10^-9   (serverless costs)
    │
micro.x10^-6  (llm token costs)
    │
milli.x10^-3  (fils: BHD, KWD, OMR)
    │
centi.x10^-2  (cents: USD, EUR, GBP — default)
    │
whole.x10^0   (whole units: JPY, KRW)
```

---

## 5. composition

### 5.1 internal flow

all arithmetic operations:
1. accept any `IsoPrice` variant via cast layer
2. convert to `IsoPriceShape` internally
3. perform computation via bigint arithmetic
4. return `IsoPriceWords` by default (or `IsoPriceShape` when `{ format: 'shape' }`)

### 5.2 precision treatment

when prices have different exponents:
1. normalize to highest precision before arithmetic
2. preserve highest precision in output
3. explicit `roundPrice` or `setPricePrecision` to decrease precision

### 5.3 currency enforcement

- all multi-price operations validate currency match
- currency mismatch throws `UnexpectedCodePathError`
- single-price operations preserve input currency

---

## 6. access layer

none — iso-price is a pure domain library.

persistence is treated at the application layer:
- `IsoPriceWords` persists to `TEXT` or custom `iso_price_words` domain
- `IsoPriceShape` can persist to composite type or 3-column pattern
- json serialization uses `IsoPriceWords` (strings serialize trivially)

---

## 7. summary

| category       | items                                                                                 |
| -------------- | ------------------------------------------------------------------------------------- |
| literals       | `IsoPriceShape`, `IsoPriceWords`, `IsoPriceHuman`                                     |
| union types    | `IsoPrice`, `IsoPriceExponent`, `IsoPriceRoundMode`                                   |
| enums          | `IsoCurrency`                                                                         |
| cast functions | `asIsoPrice`, `asIsoPriceWords`, `asIsoPriceShape`, `asIsoPriceHuman`                 |
| type guards    | `isIsoPrice`, `isIsoPriceWords`, `isIsoPriceShape`, `isIsoPriceHuman`                 |
| arithmetic     | `sumPrices`/`addPrices`, `subPrices`, `multiplyPrice`, `dividePrice`, `allocatePrice` |
| precision      | `setPricePrecision`, `roundPrice`, `getIsoPriceExponentByCurrency`                    |
| statistics     | `calcPriceStdev`                                                                      |
