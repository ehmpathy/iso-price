# iso-price persistence catalog

compressed reference for iso-price database storage patterns.

---

## quick decision

| database                         | recommendation        | doc                                                                      |
| -------------------------------- | --------------------- | ------------------------------------------------------------------------ |
| **postgres** (with extension)    | `iso_price` extension | [per302.extension](./per302.persistence.postgres.extension.[article].md) |
| **postgres** (without extension) | shape (3 columns)     | [per103.sql](./per103.persistence.primitives.sql.[article].md)           |
| **mysql / sqlite**               | shape (3 columns)     | [per103.sql](./per103.persistence.primitives.sql.[article].md)           |
| **dynamodb / mongodb**           | words (string)        | [per103.nosql](./per103.persistence.primitives.nosql.[article].md)       |
| **s3 / json files**              | words (string)        | [per103.nosql](./per103.persistence.primitives.nosql.[article].md)       |

---

## primitives (per1xx)

database-agnostic patterns and approaches.

### per101: 4 storage patterns

| pattern             | storage                     | pros                    | cons                |
| ------------------- | --------------------------- | ----------------------- | ------------------- |
| bigint + exponent â­ | `BIGINT, CHAR(3), SMALLINT` | fast, precise, flexible | 3 columns           |
| numeric             | `NUMERIC(24,12)`            | native math             | slower, fixed scale |
| composite           | `iso_price` type            | domain semantics        | less portable       |
| jsonb               | `JSONB`                     | schema-free             | no type safety      |

â†’ full details: [per101.primitives](./per101.persistence.primitives.[article].md)

### per102: shape vs words

| approach  | representation                   | best for                         |
| --------- | -------------------------------- | -------------------------------- |
| **shape** | `{ amount, currency, exponent }` | arithmetic, queries, type safety |
| **words** | `"USD 50.37"`                    | portability, human-readable      |

â†’ conceptual comparison: [per102.shape_vs_words](./per102.persistence.primitives.shape_vs_words.[article].md)

### per103: by database type

| type                             | article                                                            |
| -------------------------------- | ------------------------------------------------------------------ |
| sql (postgres, mysql, sqlite)    | [per103.sql](./per103.persistence.primitives.sql.[article].md)     |
| nosql (dynamodb, mongodb, redis) | [per103.nosql](./per103.persistence.primitives.nosql.[article].md) |

---

## extensions (per3xx)

database extensions abstract away the complexity of iso-price domain math.

### per301: why extensions?

extensions handle the hard parts automatically:
- exponent normalization for arithmetic
- custom comparison for mixed exponents
- aggregation with auto-normalization
- currency mismatch detection
- index-compatible sort order

| database   | extension support | iso_price status |
| ---------- | ----------------- | ---------------- |
| postgresql | âœ… native + pg_tle | âœ… available      |
| sqlite     | âš ï¸ limited         | ðŸ“‹ planned        |

â†’ full complexity catalog: [per301.extensions](./per301.persistence._.extensions.[article].md)

### per302: postgres extension (usage + installation)

provides both `iso_price_shape` and `iso_price_words` types.

**iso_price_shape** â€” structured storage with native arithmetic:
```sql
SELECT iso_price_shape(5037, 'USD', 2) + iso_price_shape(5, 'USD', 6);
-- â†’ (50370005, USD, 6)
```

**iso_price_words** â€” human-readable with numeric comparison:
```sql
SELECT * FROM items WHERE price > 'USD 10.00' ORDER BY price;
-- correct numeric order
```

**features:**
- arithmetic: `+`, `-`, `*`
- comparison: `=`, `<>`, `<`, `<=`, `>`, `>=`
- aggregate: `sum()` (auto-normalizes exponents)
- btree index support
- conversion functions

| platform         | pg_tle | raw sql |
| ---------------- | ------ | ------- |
| aws rds / aurora | âœ…      | âœ…       |
| supabase         | âŒ      | âœ…       |
| neon             | âŒ      | âœ…       |
| google cloud sql | âŒ      | âœ…       |
| azure postgres   | âŒ      | âœ…       |
| self-hosted      | âœ…      | âœ…       |

â†’ usage + installation: [per302.extension](./per302.persistence.postgres.extension.[article].md)

### per303: implementation reference

full sql implementation for the iso_price extension.

â†’ implementation details: [per303.implementation](./per303.persistence.postgres.extension.implementation.[guide].md)

### per304: publication guides

how to publish the extension via different channels and how users consume it.

| channel      | artifact                    | best for                        |
| ------------ | --------------------------- | ------------------------------- |
| **npm** â­    | `iso-price` package         | node.js projects (all platforms) |
| **raw sql**  | `iso_price.init.sql`        | non-node.js projects            |
| **pgxn**     | `.zip` package              | self-hosted + want `CREATE EXTENSION` |
| **pg_tle**   | `pgtle.install_extension()` | aws + want `CREATE EXTENSION`   |

â­ = simplest portable option â€” see [per304.overview](./per304.persistence.postgres.extension.publication._.[overview].md)

â†’ overview: [per304.overview](./per304.persistence.postgres.extension.publication._.[overview].md)
â†’ via pgxn: [per304.via_pgxn](./per304.persistence.postgres.extension.publication.via_pgxn.[guide].md)
â†’ via pg_tle: [per304.via_pgtle](./per304.persistence.postgres.extension.publication.via_pgtle.[guide].md)
â†’ via raw sql: [per304.via_sql](./per304.persistence.postgres.extension.publication.via_sql.[guide].md)
â†’ via npm: [per304.via_npm](./per304.persistence.postgres.extension.publication.via_npm.[guide].md)

### per305: distribution methods

how postgresql extensions are distributed: native `CREATE EXTENSION`, pgxn registry, pg_tle.

â†’ distribution: [per305.distribution](./per305.persistence.postgres.extension.distribution.[article].md)

---

## conversion functions

### shape â†’ words

```ts
const toWords = (price: IsoPriceShape): string => {
  const displayValue = Number(price.amount) / Math.pow(10, price.exponent);
  return `${price.currency} ${displayValue}`;
};
```

### words â†’ shape

```ts
const fromWords = (words: string): IsoPriceShape => {
  const [currency, valueStr] = words.split(' ');
  const decimalPlaces = (valueStr.split('.')[1] || '').length;
  const amount = BigInt(Math.round(parseFloat(valueStr) * Math.pow(10, decimalPlaces)));
  return { amount, currency, exponent: decimalPlaces };
};
```

---

## multi-currency

iso 4217 standard exponents:
- USD, EUR, GBP: 2 (cents)
- JPY, KRW: 0 (no minor unit)
- BHD, KWD, OMR: 3 (fils)

for sub-cent (api costs), override with higher exponent (6, 9, 12).

---

## sources

### primitives (per1xx)
- [per101.primitives](./per101.persistence.primitives.[article].md) â€” 4 storage patterns
- [per102.shape_vs_words](./per102.persistence.primitives.shape_vs_words.[article].md) â€” shape vs words concept
- [per103.sql](./per103.persistence.primitives.sql.[article].md) â€” sql databases
- [per103.nosql](./per103.persistence.primitives.nosql.[article].md) â€” nosql databases

### extensions (per3xx)
- [per301.extensions](./per301.persistence._.extensions.[article].md) â€” why extensions, complexity catalog, db support
- [per302.extension](./per302.persistence.postgres.extension.[article].md) â€” postgres usage + installation
- [per303.implementation](./per303.persistence.postgres.extension.implementation.[guide].md) â€” implementation reference
- [per304.overview](./per304.persistence.postgres.extension.publication._.[overview].md) â€” publication overview
- [per304.via_pgxn](./per304.persistence.postgres.extension.publication.via_pgxn.[guide].md) â€” pgxn publication
- [per304.via_pgtle](./per304.persistence.postgres.extension.publication.via_pgtle.[guide].md) â€” pg_tle publication
- [per304.via_sql](./per304.persistence.postgres.extension.publication.via_sql.[guide].md) â€” raw sql publication
- [per304.via_npm](./per304.persistence.postgres.extension.publication.via_npm.[guide].md) â€” npm publication
- [per305.distribution](./per305.persistence.postgres.extension.distribution.[article].md) â€” distribution methods
