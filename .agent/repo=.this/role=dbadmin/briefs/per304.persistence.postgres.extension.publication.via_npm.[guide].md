# publication via npm

how to publish and consume the iso_price extension via npm package.

→ for overview, see [per304.overview](./per304.persistence.postgres.extension.publication._.[overview].md)
→ for canonical sql, see [per304.via_sql](./per304.persistence.postgres.extension.publication.via_sql.[guide].md)

---

## tl;dr

npm distribution embeds the sql from [per304.via_sql](./per304.persistence.postgres.extension.publication.via_sql.[guide].md) in a node.js package for installation in migrations.

**option a: copy to schema dir (recommended)**
```sh
npm install iso-price
cp node_modules/iso-price/dist/postgres/iso_price.init.sql schema/changes/install.iso_price.sql
```

then add to `schema/control.yml`:
```yaml
- type: change
  path: ./changes/install.iso_price.sql
  id: install_iso_price_extension
```

**option b: import at runtime**
```ts
import { getIsoPriceExtensionSql } from 'iso-price/postgres';
await client.query(getIsoPriceExtensionSql());
```

---

## when to use npm

| scenario | npm? |
|----------|------|
| node.js / typescript project | ✅ yes |
| migration-based schema management | ✅ yes |
| programmatic sql execution | ✅ yes |
| manual psql installation | ❌ use raw sql |
| self-hosted with filesystem | ❌ use pgxn |

**npm is ideal for** node.js projects that manage schema via code-based migrations.

---

## publisher workflow

### 1. source the sql

copy the canonical sql from [per304.via_sql](./per304.persistence.postgres.extension.publication.via_sql.[guide].md) into `src/postgres/iso_price.init.sql`.

### 2. package structure

```
iso-price/
  package.json
  src/
    index.ts                          # main exports
    postgres/
      index.ts                        # postgres exports
      iso_price.init.sql               # canonical sql from per304.via_sql
```

### 3. package.json exports

```json
{
  "name": "iso-price",
  "version": "1.0.0",
  "exports": {
    ".": "./dist/index.js",
    "./postgres": "./dist/postgres/index.js"
  },
  "files": [
    "dist",
    "dist/postgres/*.sql"
  ]
}
```

### 4. typescript exports

```ts
// src/postgres/index.ts
import { readFileSync } from 'fs';
import { join } from 'path';

/**
 * .what = returns the raw sql for the iso_price extension
 * .why = enables programmatic installation in migrations
 */
export const getIsoPriceExtensionSql = (): string => {
  return readFileSync(join(__dirname, 'iso_price.init.sql'), 'utf-8');
};

/**
 * .what = returns sql to drop all iso_price objects
 * .why = enables clean rollback in down migrations
 */
export const getIsoPriceExtensionDropSql = (): string => {
  return readFileSync(join(__dirname, 'iso_price.drop.sql'), 'utf-8');
};
```

### 5. build process

```json
{
  "build": "tsc && npm run build:copy-sql",
  "build:copy-sql": "cp src/postgres/*.sql dist/postgres/"
}
```

### 6. publish to npm

```sh
npm version patch
npm publish
```

### 7. ci/cd automation

```yaml
# .github/workflows/release.yml
name: release
on:
  push:
    tags: ['v*']

jobs:
  npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          registry-url: 'https://registry.npmjs.org'

      - run: npm ci
      - run: npm run build
      - run: npm test

      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

---

## consumer workflow

### installation

```sh
npm install iso-price
```

### option a: copy sql to schema directory (recommended)

the simplest approach — copy the sql file directly into your schema folder and register it with [sql-schema-control](https://github.com/ehmpathy/sql-schema-control):

```sh
cp node_modules/iso-price/dist/postgres/iso_price.init.sql \
   schema/changes/install.iso_price.sql
```

then add to `schema/control.yml`:

```yaml
# schema/control.yml
language: postgres
dialect: 15
connection: ./control.connection.js
definitions:
  # iso_price extension
  - type: change
    path: ./changes/install.iso_price.sql
    id: install_iso_price_extension

  # ... your other definitions ...
```

apply with:

```sh
npx sql-schema-control plan   # preview changes
npx sql-schema-control apply  # apply changes
```

**benefits:**
- sql is version-controlled in your repo
- no runtime dependency on iso-price package
- explicit visibility of what sql runs
- declarative schema management via control.yml
- `plan` command previews changes before apply

### option b: import at runtime

alternatively, import the sql getter function for programmatic execution:

```ts
import { getIsoPriceExtensionSql } from 'iso-price/postgres';

// execute directly via pg client
await client.query(getIsoPriceExtensionSql());
```

---

## version upgrade

### publisher: new version

1. update sql from per304.via_sql (or add incremental changes)
2. bump version in package.json
3. publish

```sh
npm version minor
npm publish
```

### consumer: upgrade

since the sql is idempotent, consumers can simply re-copy and re-apply:

```sh
npm update iso-price
cp node_modules/iso-price/dist/postgres/iso_price.init.sql \
   schema/changes/install.iso_price.sql

npx sql-schema-control plan   # preview changes
npx sql-schema-control apply  # apply changes
```

alternatively, for incremental upgrades:

```yaml
definitions:
  # ... prior definitions ...

  # iso_price v1.1.0 upgrade
  - type: change
    path: ./changes/iso_price_v1.1.0_upgrade.sql
    id: upgrade_iso_price_v1.1.0
```

---

## typescript types

export domain object types alongside sql:

```ts
// src/postgres/index.ts

/**
 * typescript representation of iso_price_shape composite type
 */
export interface IsoPriceShape {
  amount: bigint;
  currency: string;
  exponent: number;
}

/**
 * typescript representation of iso_price_words domain
 * format: "CUR amount" (e.g., "USD 50.37")
 */
export type IsoPriceWords = string;

// ... sql export functions ...
```

---

## directory structure (full)

```
iso-price/
  package.json
  tsconfig.json
  src/
    index.ts                          # main package exports
    domain/
      IsoPriceShape.ts                # domain object
      IsoPriceWords.ts                # domain type
    postgres/
      index.ts                        # postgres sql exports
      iso_price.init.sql              # canonical sql (from per304.via_sql)
      iso_price.drop.sql              # uninstall sql (from per304.via_sql)
  dist/                               # built output
    index.js
    postgres/
      index.js
      iso_price.init.sql
      iso_price.drop.sql
```

---

## sources

- [per304.via_sql](./per304.persistence.postgres.extension.publication.via_sql.[guide].md) — canonical sql implementation
- [npm: package.json exports](https://nodejs.org/api/packages.html#exports)
- [sql-schema-control: github](https://github.com/ehmpathy/sql-schema-control)
