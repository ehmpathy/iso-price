# publication via pgxn

how to publish and consume the iso_price extension via pgxn (postgresql extension network).

→ for overview, see [per304.overview](./per304.persistence.postgres.extension.publication._.[overview].md)

---

## tl;dr

pgxn is the **open registry** for postgresql extensions — similar to npm for node.js or pypi for python.

```sh
# consumer installation
pgxn install iso_price
pgxn load iso_price

# then in psql
CREATE EXTENSION iso_price;
```

---

## what is pgxn?

[pgxn.org](https://pgxn.org) is the community-run, open registry for postgresql extensions.

**no gatekeeper** — anyone can publish. the only requirements:
- valid `META.json` metadata file
- valid `.control` file
- sql definition files

---

## platform support

| platform | pgxn support |
|----------|--------------|
| self-hosted postgres | ✅ yes |
| docker postgres | ✅ yes |
| aws rds / aurora | ❌ no (no filesystem) |
| supabase | ❌ no |
| neon | ❌ no |
| google cloud sql | ❌ no |
| azure postgres | ❌ no |

**pgxn requires filesystem access** — it installs files to `$SHAREDIR/extension/`.

---

## publisher workflow

### 1. create control file

```ini
# iso_price.control
comment = 'ISO-compliant price types for PostgreSQL'
default_version = '1.0.0'
relocatable = true
requires = ''
```

| field | purpose |
|-------|---------|
| `comment` | description shown in `\dx` |
| `default_version` | version installed when none specified |
| `relocatable` | can be moved to different schema |
| `requires` | dependencies on other extensions |

### 2. create sql definition file

```sql
-- iso_price--1.0.0.sql
CREATE TYPE iso_price_shape AS (
  amount BIGINT,
  currency CHAR(3),
  exponent SMALLINT
);

-- ... all definitions ...
```

### 3. create META.json

```json
{
  "name": "iso_price",
  "abstract": "ISO-compliant price types for PostgreSQL",
  "version": "1.0.0",
  "maintainer": "you@example.com",
  "license": "mit",
  "provides": {
    "iso_price": {
      "file": "iso_price--1.0.0.sql",
      "version": "1.0.0"
    }
  },
  "resources": {
    "homepage": "https://github.com/ehmpathy/iso-price",
    "bugtracker": {
      "web": "https://github.com/ehmpathy/iso-price/issues"
    },
    "repository": {
      "url": "https://github.com/ehmpathy/iso-price.git",
      "web": "https://github.com/ehmpathy/iso-price",
      "type": "git"
    }
  },
  "generated_by": "hand",
  "meta-spec": {
    "version": "1.0.0",
    "url": "https://pgxn.org/meta/spec.txt"
  }
}
```

### 4. create distribution archive

```sh
# directory structure
iso_price-1.0.0/
  META.json
  iso_price.control
  iso_price--1.0.0.sql
  Makefile              # optional, for pgxs build
  README.md             # optional

# create zip
zip -r iso_price-1.0.0.zip iso_price-1.0.0/
```

### 5. upload to pgxn

1. create account at [manager.pgxn.org](https://manager.pgxn.org)
2. upload the `.zip` file via web interface
3. pgxn validates and publishes

### 6. ci/cd automation

```yaml
# .github/workflows/release.yml
name: release
on:
  push:
    tags: ['v*']

jobs:
  pgxn:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: build pgxn package
        run: |
          mkdir -p iso_price-${{ github.ref_name }}
          cp META.json iso_price.control iso_price--*.sql iso_price-${{ github.ref_name }}/
          zip -r iso_price-${{ github.ref_name }}.zip iso_price-${{ github.ref_name }}/

      - name: upload to pgxn
        run: |
          # pgxn-utils or curl to manager.pgxn.org
          curl -X POST \
            -F "archive=@iso_price-${{ github.ref_name }}.zip" \
            -u "${{ secrets.PGXN_USERNAME }}:${{ secrets.PGXN_PASSWORD }}" \
            https://manager.pgxn.org/upload
```

---

## consumer workflow

### install pgxn client

```sh
# via pip
pip install pgxnclient

# verify
pgxn --version
```

### install extension

```sh
# download and install to $SHAREDIR
pgxn install iso_price

# or specific version
pgxn install iso_price=1.0.0
```

### load extension

```sh
# load into database
pgxn load iso_price -d your_database

# or manually in psql
psql -d your_database -c "CREATE EXTENSION iso_price;"
```

### verify

```sql
-- list extensions
\dx iso_price
-- → iso_price | 1.0.0 | public | ISO-compliant price types...

-- test
SELECT iso_price_shape(5037, 'USD', 2);
-- → (5037,USD,2)
```

---

## upgrade workflow

### publisher: create upgrade path

```sql
-- iso_price--1.0.0--1.1.0.sql
-- upgrade from 1.0.0 to 1.1.0

CREATE FUNCTION iso_price_shape_abs(p iso_price_shape)
RETURNS iso_price_shape AS $$
  SELECT iso_price_shape(ABS((p).amount), (p).currency, (p).exponent);
$$ LANGUAGE SQL IMMUTABLE STRICT;
```

update control file:

```ini
# iso_price.control
default_version = '1.1.0'
```

### consumer: upgrade

```sh
# install new version
pgxn install iso_price=1.1.0

# upgrade in database
psql -d your_database -c "ALTER EXTENSION iso_price UPDATE TO '1.1.0';"
```

---

## makefile (optional)

for `make install` support:

```makefile
# Makefile
EXTENSION = iso_price
DATA = iso_price--1.0.0.sql

PG_CONFIG = pg_config
PGXS := $(shell $(PG_CONFIG) --pgxs)
include $(PGXS)
```

consumers can then:

```sh
# manual installation via pgxs
pgxn download iso_price
cd iso_price-1.0.0
make
make install
```

---

## directory structure

```
iso_price/
  META.json                     # pgxn metadata
  iso_price.control             # extension control file
  iso_price--1.0.0.sql          # version 1.0.0 definitions
  iso_price--1.0.0--1.1.0.sql   # upgrade path 1.0.0 → 1.1.0
  iso_price--1.1.0.sql          # version 1.1.0 definitions
  Makefile                      # pgxs build (optional)
  README.md                     # documentation
```

---

## sources

- [pgxn: how to create and distribute extensions](https://manager.pgxn.org/howto)
- [pgxn: META.json spec](https://pgxn.org/meta/spec.txt)
- [postgresql: extension package structure](https://www.postgresql.org/docs/current/extend-extensions.html)
- [postgresql: pgxs build infrastructure](https://www.postgresql.org/docs/current/extend-pgxs.html)
- [pgxnclient documentation](https://pgxn.github.io/pgxnclient/)
