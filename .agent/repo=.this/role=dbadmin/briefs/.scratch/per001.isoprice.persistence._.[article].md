# iso-price postgresql persistence

compressed reference for agent consumption. refs to detailed briefs below.

---

## core concept

```ts
IsoPrice = IsoPriceShape | IsoPriceWords
```

**IsoPriceShape** = `{ amount: bigint, currency: string, exponent: number }`
- `amount` = integer in minor units (no floats)
- `currency` = ISO 4217 code (USD, EUR, JPY)
- `exponent` = decimal places (2=cents, 6=micro, 9=nano, 12=pico)

**IsoPriceWords** = `"{currency} {display_value}"` (e.g., `"USD 50.37"`)

formula: `displayValue = amount / 10^exponent`

example: `{ amount: 5037, currency: 'USD', exponent: 2 }` = `"USD 50.37"` = $50.37

---

## two persistence approaches

| approach | pg type | storage | arithmetic | sort |
|----------|---------|---------|------------|------|
| **IsoPriceShape** | `iso_price_shape` | composite `(amount, currency, exponent)` | ✅ native sql | ✅ numeric |
| **IsoPriceWords** | `iso_price_words` | TEXT `"USD 50.37"` | ❌ app layer | ✅ numeric (with type) |

### IsoPriceShape

structured composite type with full sql arithmetic.

```sql
-- type: (5037, 'USD', 2)
SELECT iso_price_shape(5037, 'USD', 2) + iso_price_shape(5, 'USD', 6);
-- result: (50370005, USD, 6) — auto-normalizes to most granular exponent
```

**use when**: sql aggregation needed, query by currency/exponent, large datasets

### IsoPriceWords

human-readable prefix-code format: `{currency} {display_value}`

```sql
-- type: 'USD 50.37'
INSERT INTO prices (price) VALUES ('USD 50.37');
```

**use when**: portability, simplicity, nosql, prices are display-only

---

## quick decision

| need | → shape | → words |
|------|---------|---------|
| sql SUM/AVG | ✅ | ❌ |
| filter by currency | ✅ | ❌ |
| portable (mysql, dynamo) | ❌ | ✅ |
| human-readable | ❌ | ✅ |
| simple schema | ❌ | ✅ |

**default**: use `iso_price_shape` for postgresql. use `iso_price_words` for nosql or cross-db portability.

---

## postgresql types

two custom types available:

### iso_price_shape (composite)

```sql
CREATE TYPE iso_price_shape AS (
  amount BIGINT,
  currency CHAR(3),
  exponent SMALLINT
);
```

features:
- operators: `+`, `-`, `*`, `=`, `<`, `>`, `<=`, `>=`, `<>`
- aggregates: `sum()`, `iso_price_shape_sum()`
- functions: `iso_price_shape_display()`, `iso_price_shape_normalize()`
- btree indexes via `iso_price_shape_ops` operator class

### iso_price_words (domain)

```sql
CREATE DOMAIN iso_price_words AS TEXT
  CHECK (VALUE ~ '^[A-Z]{3} -?[0-9]+(\.[0-9]+)?$');
```

features:
- comparison operators: `=`, `<`, `>`, `<=`, `>=`, `<>` (numeric, not lexicographic)
- btree indexes via `iso_price_words_ops` operator class
- utility: `iso_price_words_currency()`, `iso_price_words_value()`

---

## installation

### pg_tle (aws rds/aurora)

```sql
CREATE EXTENSION pg_tle;
-- run pgtle registration sql
CREATE EXTENSION iso_price_shape;
```

### raw sql (supabase, neon, gcp, azure)

run the extension sql directly in migrations.

→ see `per301.postgres.isoprice.extension.[guide].install.md`

---

## platform compatibility

| platform | pg_tle | raw sql |
|----------|--------|---------|
| aws rds/aurora | ✅ | ✅ |
| supabase | ❌ | ✅ |
| neon | ❌ | ✅ |
| gcp cloud sql | ❌ | ✅ |
| azure postgres | ❌ | ✅ |
| self-hosted | ✅ | ✅ |

---

## detailed refs

| topic | brief |
|-------|-------|
| persistence patterns overview | `per101.isoprice.persistence._.[article].md` |
| shape vs words comparison | `per201.isoprice.persistence.approaches.[article].shape_vs_words.md` |
| raw sql extension | `per301.postgres.isoprice.extension.[ref].raw_sql.md` |
| pg_tle extension | `per301.postgres.isoprice.extension.[ref].pgtle.md` |
| installation guide | `per301.postgres.isoprice.extension.[guide].install.md` |

---

## key formulas

```sql
-- shape to display value
SELECT (p).amount::NUMERIC / POWER(10, (p).exponent) FROM prices;

-- words to numeric value
SELECT split_part(price, ' ', 2)::NUMERIC FROM prices;

-- normalize shape to target exponent
SELECT iso_price_shape_normalize(price, 6) FROM prices;  -- normalize to micro
```

---

## common patterns

### sum with mixed exponents

```sql
-- auto-normalizes to most granular exponent
SELECT sum(price) FROM invoice_line_items WHERE (price).currency = 'USD';
```

### compare prices

```sql
-- works across different exponents
SELECT * FROM prices WHERE price > iso_price_shape(1000, 'USD', 2);  -- > $10
```

### display formatted

```sql
SELECT description, iso_price_shape_display(price) AS amount
FROM invoice_line_items;
```
