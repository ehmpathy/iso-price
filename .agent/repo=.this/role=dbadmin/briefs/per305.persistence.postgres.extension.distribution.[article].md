# postgresql extension distribution methods

how postgresql extensions are distributed and installed via `CREATE EXTENSION`.

→ for iso_price publication, see [per304.publication](./per304.persistence.postgres.extension.publication.[guide].md)

---

## tl;dr

| method | requires filesystem? | managed postgres? | registry |
|--------|---------------------|-------------------|----------|
| **native extension** | ✅ yes | ❌ no | pgxn (open) |
| **pg_tle** | ❌ no | ✅ yes (aws) | none |
| **raw sql** | ❌ no | ✅ yes (all) | none |

**constraint**: native `CREATE EXTENSION` requires files in the server's `share/extension/` directory — managed postgres (rds, cloud sql, supabase, neon) blocks filesystem access.

---

## native postgresql extensions

### how `CREATE EXTENSION` works

when you run `CREATE EXTENSION iso_price`, postgresql looks for two files in `$SHAREDIR/extension/`:

```
/usr/share/postgresql/15/extension/
  iso_price.control              # metadata
  iso_price--1.0.0.sql           # sql definitions
```

### control file

the `.control` file declares extension metadata:

```ini
# iso_price.control
comment = 'ISO-compliant price types for PostgreSQL'
default_version = '1.0.0'
relocatable = true
requires = ''
```

| field | purpose |
|-------|---------|
| `comment` | description shown in `\dx` |
| `default_version` | version installed when none specified |
| `relocatable` | can be moved to different schema |
| `requires` | dependencies on other extensions |

### sql definition file

the `--version.sql` file contains all `CREATE TYPE`, `CREATE FUNCTION`, `CREATE OPERATOR` statements:

```sql
-- iso_price--1.0.0.sql
CREATE TYPE iso_price_shape AS ( ... );
CREATE FUNCTION iso_price_shape( ... ) ...;
-- ... all definitions ...
```

### upgrade files

version migrations use `--oldversion--newversion.sql`:

```
iso_price--1.0.0--1.1.0.sql    # upgrade from 1.0.0 to 1.1.0
iso_price--1.1.0--1.2.0.sql    # upgrade from 1.1.0 to 1.2.0
```

```sql
ALTER EXTENSION iso_price UPDATE TO '1.1.0';
```

### installation

users install via package manager or manual file copy:

```sh
# debian/ubuntu (if packaged)
apt install postgresql-15-iso-price

# manual installation
cp iso_price.control /usr/share/postgresql/15/extension/
cp iso_price--*.sql /usr/share/postgresql/15/extension/
```

then:

```sql
CREATE EXTENSION iso_price;
```

---

## pgxn: the extension registry

### what is pgxn?

[pgxn](https://pgxn.org) (postgresql extension network) is the open, community-run registry for postgresql extensions.

**no gatekeeper** — anyone can publish. similar to npm for node.js or pypi for python.

### publish to pgxn

1. create `META.json` with extension metadata:

```json
{
  "name": "iso_price",
  "version": "1.0.0",
  "abstract": "ISO-compliant price types for PostgreSQL",
  "maintainer": "you@example.com",
  "license": "mit",
  "provides": {
    "iso_price": {
      "file": "iso_price--1.0.0.sql",
      "version": "1.0.0"
    }
  },
  "meta-spec": {
    "version": "1.0.0",
    "url": "https://pgxn.org/meta/spec.txt"
  }
}
```

2. create distribution archive:

```sh
zip iso_price-1.0.0.zip META.json iso_price.control iso_price--1.0.0.sql
```

3. upload to pgxn via [manager.pgxn.org](https://manager.pgxn.org)

### install from pgxn

users install via `pgxn` client:

```sh
# install pgxn client
pip install pgxnclient

# install extension
pgxn install iso_price
pgxn load iso_price
```

or via `pgxs` build:

```sh
pgxn download iso_price
cd iso_price-1.0.0
make
make install
```

---

## the managed postgres problem

### why native extensions don't work

managed postgres services (aws rds, google cloud sql, azure, supabase, neon) **block filesystem access**:

- you cannot write to `$SHAREDIR/extension/`
- you cannot install system packages
- you cannot use `pgxn install`

only **pre-approved extensions** bundled by the provider are available.

### workarounds

| approach | works on managed? | `CREATE EXTENSION` syntax? |
|----------|-------------------|---------------------------|
| raw sql file | ✅ yes | ❌ no (`\i file.sql`) |
| pg_tle | ✅ yes (aws only) | ✅ yes |
| request from provider | maybe | ✅ yes |

---

## pg_tle: trusted language extensions

### what is pg_tle?

[pg_tle](https://github.com/aws/pg_tle) is aws's solution for extension installation without filesystem access.

extensions are stored **in the database** (not filesystem), registered via sql:

```sql
SELECT pgtle.install_extension(
  'iso_price',
  '1.0.0',
  'ISO-compliant price types',
  $_pgtle_$
    CREATE TYPE iso_price_shape AS ( ... );
    -- ... all definitions ...
  $_pgtle_$
);
```

then users can:

```sql
CREATE EXTENSION iso_price;  -- works!
```

### platform support

| platform | pg_tle support |
|----------|---------------|
| aws rds / aurora | ✅ yes |
| supabase | ❌ no |
| neon | ❌ no |
| google cloud sql | ❌ no |
| azure postgres | ❌ no |
| self-hosted | ✅ yes |

---

## recommendation for iso_price

### multi-channel distribution

since no single method works everywhere, distribute via all channels:

| channel | artifact | consumer |
|---------|----------|----------|
| **pgxn** | `.zip` with control + sql | self-hosted users |
| **pg_tle sql** | `pgtle.install_extension()` | aws rds/aurora |
| **raw sql** | standalone `.sql` file | all platforms |
| **npm** | embedded sql in package | node.js projects |

### installation matrix

| platform | recommended method |
|----------|-------------------|
| self-hosted | `pgxn install iso_price` or native |
| aws rds/aurora | pg_tle |
| supabase, neon, cloud sql | raw sql file |
| node.js project | `npm install iso-price` + migration |

---

## sources

- [postgresql: packaging extensions](https://www.postgresql.org/docs/current/extend-extensions.html)
- [postgresql: CREATE EXTENSION](https://www.postgresql.org/docs/current/sql-createextension.html)
- [postgresql: pgxs build infrastructure](https://www.postgresql.org/docs/current/extend-pgxs.html)
- [pgxn: how to create and distribute extensions](https://manager.pgxn.org/howto)
- [github: aws/pg_tle](https://github.com/aws/pg_tle)
