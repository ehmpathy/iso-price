# iso_price postgresql extension implementation

design reference for the iso_price extension implementation.

→ for full sql implementation, see [per304.via_sql](./per304.persistence.postgres.extension.publication.via_sql.[guide].md)
→ for usage guide, see [per302.extension](./per302.persistence.postgres.extension.[article].md)
→ for publication channels, see [per304.overview](./per304.persistence.postgres.extension.publication._.[overview].md)

---

## overview

the extension provides two complementary types:

| type | implementation | features |
|------|----------------|----------|
| `iso_price_shape` | composite type | arithmetic, aggregation, comparison |
| `iso_price_words` | domain over TEXT | numeric comparison, format validation |

**approach**: pure sql + plpgsql (works on managed postgres: aws rds/aurora, supabase, neon, gcp cloud sql, azure)

---

## design

### iso_price_shape

composite type with three fields:

```sql
CREATE TYPE iso_price_shape AS (
  amount BIGINT,        -- integer in minor units
  currency CHAR(3),     -- iso 4217 currency code
  exponent SMALLINT     -- decimal places (2=cents, 6=micro, 9=nano, 12=pico)
);
```

**features:**
- constructor: `iso_price_shape(amount, currency, exponent)`
- arithmetic: `+`, `-`, `*` (auto-normalizes exponents)
- comparison: `=`, `<>`, `<`, `<=`, `>`, `>=`
- aggregation: `sum()` with auto-normalization
- btree index support via operator class

### iso_price_words

domain over TEXT with format validation:

```sql
CREATE DOMAIN iso_price_words AS TEXT
  CHECK (VALUE ~ '^[A-Z]{3} -?[0-9]+(\.[0-9]+)?$');
```

format: `{currency} {display_value}` (e.g., `'USD 50.37'`)

**features:**
- numeric comparison: `=`, `<>`, `<`, `<=`, `>`, `>=`
- btree index support via operator class
- format validation via domain constraint

### conversion

```sql
-- shape to words
SELECT iso_price_shape_to_words(price) FROM items;
-- (5037, USD, 2) → 'USD 50.37'

-- words to shape (infers exponent from decimal places)
SELECT iso_price_words_to_shape('USD 50.37');
-- → (5037, USD, 2)
```

---

## idempotent design

the sql is designed for idempotent execution (safe to replay for upgrades):

| object | idempotent pattern |
|--------|-------------------|
| types/domains | `DO $ BEGIN CREATE ... EXCEPTION WHEN duplicate_object THEN NULL; END $;` |
| functions | `CREATE OR REPLACE FUNCTION` |
| operators | `DROP OPERATOR IF EXISTS` + `CREATE OPERATOR` |
| aggregates | `DROP AGGREGATE IF EXISTS` + `CREATE AGGREGATE` |
| operator classes | `DROP OPERATOR CLASS IF EXISTS` + `CREATE OPERATOR CLASS` |

**limitation**: composite type field changes require migration when tables reference the type.

---

## object inventory

### iso_price_shape objects

| category | objects |
|----------|---------|
| type | `iso_price_shape` |
| constructor | `iso_price_shape(amount, currency, exponent)` |
| utility | `iso_price_shape_display`, `iso_price_shape_normalize` |
| arithmetic | `iso_price_shape_add`, `iso_price_shape_subtract`, `iso_price_shape_negate`, `iso_price_shape_multiply`, `iso_price_shape_multiply_rev` |
| comparison | `iso_price_shape_cmp`, `iso_price_shape_eq`, `iso_price_shape_ne`, `iso_price_shape_lt`, `iso_price_shape_le`, `iso_price_shape_gt`, `iso_price_shape_ge` |
| operators | `+`, `-`, `*`, `=`, `<>`, `<`, `<=`, `>`, `>=` |
| aggregate | `sum(iso_price_shape)`, `iso_price_shape_sum_sfunc` |
| operator class | `iso_price_shape_ops` (btree) |

### iso_price_words objects

| category | objects |
|----------|---------|
| domain | `iso_price_words` |
| utility | `iso_price_words_currency`, `iso_price_words_value` |
| comparison | `iso_price_words_cmp`, `iso_price_words_eq`, `iso_price_words_ne`, `iso_price_words_lt`, `iso_price_words_le`, `iso_price_words_gt`, `iso_price_words_ge` |
| operators | `=`, `<>`, `<`, `<=`, `>`, `>=` |
| operator class | `iso_price_words_ops` (btree) |

### conversion objects

| category | objects |
|----------|---------|
| functions | `iso_price_shape_to_words`, `iso_price_words_to_shape` |

---

## sources

- [per304.via_sql](./per304.persistence.postgres.extension.publication.via_sql.[guide].md) — canonical sql implementation
- [postgresql: composite types](https://www.postgresql.org/docs/current/rowtypes.html)
- [postgresql: create domain](https://www.postgresql.org/docs/current/sql-createdomain.html)
- [postgresql: user-defined aggregates](https://www.postgresql.org/docs/current/xaggr.html)
- [postgresql: operator classes](https://www.postgresql.org/docs/current/indexes-opclass.html)
